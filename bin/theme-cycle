#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
REPO_DIR="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd)"
THEMES_DIR="$REPO_DIR/themes"
CURRENT_FILE="$HOME/.config/theme-switch/current"
SWITCHER="$HOME/.local/bin/theme-switch"

mapfile -t THEMES < <(find "$THEMES_DIR" -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | sort)
if [[ ${#THEMES[@]} -eq 0 ]]; then
  echo "No themes found in $THEMES_DIR"
  exit 1
fi

CURRENT=""
if [[ -f "$CURRENT_FILE" ]]; then
  CURRENT="$(<"$CURRENT_FILE")"
fi

NEXT_INDEX=0
for i in "${!THEMES[@]}"; do
  if [[ "${THEMES[$i]}" == "$CURRENT" ]]; then
    NEXT_INDEX=$(( (i + 1) % ${#THEMES[@]} ))
    break
  fi
done

exec "$SWITCHER" "${THEMES[$NEXT_INDEX]}"
