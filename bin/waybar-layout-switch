#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
REPO_DIR="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd)"
LAYOUT_DIR="$REPO_DIR/waybar/layouts"
TARGET_CONFIG="$REPO_DIR/waybar/config"
STATE_DIR="$HOME/.config/waybar-layout"
CURRENT_FILE="$STATE_DIR/current"

usage() {
  cat <<'USAGE'
Usage:
  waybar-layout-switch --list
  waybar-layout-switch <layout-name> [--save-slot <slot-name>]

Examples:
  waybar-layout-switch clean-v1 --save-slot shift-f1-current
  waybar-layout-switch shift-f1-current
USAGE
}

list_layouts() {
  find "$LAYOUT_DIR" -mindepth 1 -maxdepth 1 -name '*.json' -type f -printf '%f\n' | sed 's/\.json$//' | sort
}

if [[ "${1:-}" == "--list" ]]; then
  list_layouts
  exit 0
fi

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

LAYOUT="$1"
shift

SAVE_SLOT=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --save-slot)
      SAVE_SLOT="${2:-}"
      shift 2
      ;;
    *)
      echo "Unknown arg: $1"
      usage
      exit 1
      ;;
  esac
done

TARGET_LAYOUT="$LAYOUT_DIR/$LAYOUT.json"
if [[ ! -f "$TARGET_LAYOUT" ]]; then
  echo "Layout not found: $LAYOUT"
  echo "Available:"
  list_layouts | sed 's/^/  - /'
  exit 1
fi

mkdir -p "$STATE_DIR"

if [[ -n "$SAVE_SLOT" ]] && ! cmp -s "$TARGET_CONFIG" "$TARGET_LAYOUT"; then
  cp "$TARGET_CONFIG" "$LAYOUT_DIR/$SAVE_SLOT.json"
fi

cp "$TARGET_LAYOUT" "$TARGET_CONFIG"
printf '%s\n' "$LAYOUT" > "$CURRENT_FILE"

if pgrep -x waybar >/dev/null 2>&1; then
  pkill -USR2 -x waybar >/dev/null 2>&1 || true
elif command -v systemctl >/dev/null 2>&1; then
  systemctl --user restart waybar.service >/dev/null 2>&1 || true
fi

echo "Applied waybar layout: $LAYOUT"
