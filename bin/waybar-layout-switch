#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
REPO_DIR="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd)"
LAYOUT_DIR="$REPO_DIR/waybar/layouts"
TARGET_CONFIG="$REPO_DIR/waybar/config"
TARGET_STYLE="$REPO_DIR/waybar/style.css"
STATE_DIR="$HOME/.config/waybar-layout"
SLOT_DIR="$STATE_DIR/slots"
CURRENT_FILE="$STATE_DIR/current"

usage() {
  cat <<'USAGE'
Usage:
  waybar-layout-switch --list
  waybar-layout-switch <layout-name> [--save-slot <slot-name>]

Examples:
  waybar-layout-switch clean-v1 --save-slot shift-f1-current
  waybar-layout-switch shift-f1-current
USAGE
}

list_layouts() {
  {
    find "$LAYOUT_DIR" -mindepth 1 -maxdepth 1 -name '*.json' -type f -printf '%f\n' | sed 's/\.json$//'
    find "$SLOT_DIR" -mindepth 1 -maxdepth 1 -name '*.json' -type f -printf '%f\n' 2>/dev/null | sed 's/\.json$//'
  } | sort -u
}

if [[ "${1:-}" == "--list" ]]; then
  list_layouts
  exit 0
fi

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

LAYOUT="$1"
shift

SAVE_SLOT=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --save-slot)
      SAVE_SLOT="${2:-}"
      shift 2
      ;;
    *)
      echo "Unknown arg: $1"
      usage
      exit 1
      ;;
  esac
done

mkdir -p "$STATE_DIR"
mkdir -p "$SLOT_DIR"

TARGET_LAYOUT="$LAYOUT_DIR/$LAYOUT.json"
TARGET_LAYOUT_STYLE="$LAYOUT_DIR/$LAYOUT.css"
if [[ ! -f "$TARGET_LAYOUT" ]]; then
  TARGET_LAYOUT="$SLOT_DIR/$LAYOUT.json"
  TARGET_LAYOUT_STYLE="$SLOT_DIR/$LAYOUT.css"
fi

# Convenience: first press of restore slot seeds it from current files.
if [[ ! -f "$TARGET_LAYOUT" && "$LAYOUT" == "shift-f1-current" ]]; then
  cp "$TARGET_CONFIG" "$SLOT_DIR/$LAYOUT.json"
  cp "$TARGET_STYLE" "$SLOT_DIR/$LAYOUT.css"
  TARGET_LAYOUT="$SLOT_DIR/$LAYOUT.json"
  TARGET_LAYOUT_STYLE="$SLOT_DIR/$LAYOUT.css"
fi

if [[ ! -f "$TARGET_LAYOUT" ]]; then
  echo "Layout not found: $LAYOUT"
  echo "Available:"
  list_layouts | sed 's/^/  - /'
  exit 1
fi

if [[ -n "$SAVE_SLOT" ]] && ! cmp -s "$TARGET_CONFIG" "$TARGET_LAYOUT"; then
  cp "$TARGET_CONFIG" "$SLOT_DIR/$SAVE_SLOT.json"
  cp "$TARGET_STYLE" "$SLOT_DIR/$SAVE_SLOT.css"
fi

cp "$TARGET_LAYOUT" "$TARGET_CONFIG"
if [[ -f "$TARGET_LAYOUT_STYLE" ]]; then
  cp "$TARGET_LAYOUT_STYLE" "$TARGET_STYLE"
fi
printf '%s\n' "$LAYOUT" > "$CURRENT_FILE"

if pgrep -x waybar >/dev/null 2>&1; then
  pkill -USR2 -x waybar >/dev/null 2>&1 || true
elif command -v systemctl >/dev/null 2>&1; then
  systemctl --user restart waybar.service >/dev/null 2>&1 || true
fi

echo "Applied waybar layout: $LAYOUT"
